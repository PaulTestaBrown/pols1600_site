<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.545">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Your Name HERE">
<meta name="dcterms.date" content="2024-01-24">

<title>POLS 1600 - Lab 02 - Visualizing data on COVID-19 in the U.S.</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">POLS 1600</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../syllabus.html"> 
<span class="menu-text">Syllabus</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../class/index.html"> 
<span class="menu-text">Class</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../assignments.qmd"> 
<span class="menu-text">Assignments</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul class="collapse">
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#please-knit-this-.rmd-file" id="toc-please-knit-this-.rmd-file" class="nav-link" data-scroll-target="#please-knit-this-.rmd-file">Please knit this .Rmd file</a></li>
  <li><a href="#describe-the-components-of-the-figure-youre-trying-to-reprodce" id="toc-describe-the-components-of-the-figure-youre-trying-to-reprodce" class="nav-link" data-scroll-target="#describe-the-components-of-the-figure-youre-trying-to-reprodce"><span class="header-section-number">1</span> Describe the components of the figure you’re trying to reprodce</a></li>
  <li><a href="#outline-the-steps-you-will-need-to-complete-this-process" id="toc-outline-the-steps-you-will-need-to-complete-this-process" class="nav-link" data-scroll-target="#outline-the-steps-you-will-need-to-complete-this-process">Outline the steps you will need to complete this process</a></li>
  <li><a href="#set-up-our-workspace" id="toc-set-up-our-workspace" class="nav-link" data-scroll-target="#set-up-our-workspace"><span class="header-section-number">2</span> Set up our workspace</a>
  <ul class="collapse">
  <li><a href="#create-an-object-listing-all-the-packages-i-will-use-today" id="toc-create-an-object-listing-all-the-packages-i-will-use-today" class="nav-link" data-scroll-target="#create-an-object-listing-all-the-packages-i-will-use-today"><span class="header-section-number">2.1</span> Create an object listing all the packages I will use today</a></li>
  <li><a href="#define-a-function-to-install-and-load-packages" id="toc-define-a-function-to-install-and-load-packages" class="nav-link" data-scroll-target="#define-a-function-to-install-and-load-packages"><span class="header-section-number">2.2</span> Define a function to install and load packages</a></li>
  <li><a href="#use-the-ipak-function-to-load-the-necessary-packages" id="toc-use-the-ipak-function-to-load-the-necessary-packages" class="nav-link" data-scroll-target="#use-the-ipak-function-to-load-the-necessary-packages"><span class="header-section-number">2.3</span> Use the ipak function to load the necessary packages</a></li>
  </ul></li>
  <li><a href="#download-the-covid-19-data" id="toc-download-the-covid-19-data" class="nav-link" data-scroll-target="#download-the-covid-19-data"><span class="header-section-number">3</span> Download the COVID-19 data</a></li>
  <li><a href="#get-a-high-level-overview-of-the-data" id="toc-get-a-high-level-overview-of-the-data" class="nav-link" data-scroll-target="#get-a-high-level-overview-of-the-data"><span class="header-section-number">4</span> Get a high level overview of the data</a></li>
  <li><a href="#recode-the-data" id="toc-recode-the-data" class="nav-link" data-scroll-target="#recode-the-data"><span class="header-section-number">5</span> Recode the data</a>
  <ul class="collapse">
  <li><a href="#filter-out-u.s.-territories" id="toc-filter-out-u.s.-territories" class="nav-link" data-scroll-target="#filter-out-u.s.-territories"><span class="header-section-number">5.1</span> Filter out U.S. Territories</a></li>
  <li><a href="#create-a-state-variable" id="toc-create-a-state-variable" class="nav-link" data-scroll-target="#create-a-state-variable"><span class="header-section-number">5.2</span> Create a <code>state</code> variable</a></li>
  <li><a href="#group-by-the-state-variable-to-calculate-new-covid-19-cases" id="toc-group-by-the-state-variable-to-calculate-new-covid-19-cases" class="nav-link" data-scroll-target="#group-by-the-state-variable-to-calculate-new-covid-19-cases"><span class="header-section-number">5.3</span> Group by the <code>state</code> variable to calculate new Covid-19 cases</a></li>
  <li><a href="#recode-the-facial_coverings-variable" id="toc-recode-the-facial_coverings-variable" class="nav-link" data-scroll-target="#recode-the-facial_coverings-variable"><span class="header-section-number">5.4</span> Recode the <code>facial_coverings</code> variable</a></li>
  <li><a href="#create-a-variable-capturing-the-year-and-month-of-the-observation" id="toc-create-a-variable-capturing-the-year-and-month-of-the-observation" class="nav-link" data-scroll-target="#create-a-variable-capturing-the-year-and-month-of-the-observation"><span class="header-section-number">5.5</span> Create a variable capturing the year and month of the observation</a></li>
  </ul></li>
  <li><a href="#calculate-the-average-number-of-new-cases-in-a-given-month-for-states-with-a-given-policy-on-face-mask" id="toc-calculate-the-average-number-of-new-cases-in-a-given-month-for-states-with-a-given-policy-on-face-mask" class="nav-link" data-scroll-target="#calculate-the-average-number-of-new-cases-in-a-given-month-for-states-with-a-given-policy-on-face-mask"><span class="header-section-number">6</span> Calculate the average number of new cases in a given month for states with a given policy on face mask</a></li>
  <li><a href="#reproduce-the-figure-from-lab-01" id="toc-reproduce-the-figure-from-lab-01" class="nav-link" data-scroll-target="#reproduce-the-figure-from-lab-01"><span class="header-section-number">7</span> Reproduce the figure from Lab 01</a></li>
  <li><a href="#optional-refine-the-figure" id="toc-optional-refine-the-figure" class="nav-link" data-scroll-target="#optional-refine-the-figure"><span class="header-section-number">8</span> Optional: Refine the figure</a>
  <ul class="collapse">
  <li><a href="#adding-meaningful-labels-and-title" id="toc-adding-meaningful-labels-and-title" class="nav-link" data-scroll-target="#adding-meaningful-labels-and-title"><span class="header-section-number">8.1</span> Adding meaningful labels and title</a></li>
  <li><a href="#changing-the-theme-of-the-plot" id="toc-changing-the-theme-of-the-plot" class="nav-link" data-scroll-target="#changing-the-theme-of-the-plot"><span class="header-section-number">8.2</span> Changing the theme of the plot</a></li>
  <li><a href="#make-the-size-of-the-dots-reflect-the-number-of-states-with-this-policy" id="toc-make-the-size-of-the-dots-reflect-the-number-of-states-with-this-policy" class="nav-link" data-scroll-target="#make-the-size-of-the-dots-reflect-the-number-of-states-with-this-policy"><span class="header-section-number">8.3</span> Make the size of the dots reflect the number of states with this policy</a></li>
  <li><a href="#facet-the-plot" id="toc-facet-the-plot" class="nav-link" data-scroll-target="#facet-the-plot"><span class="header-section-number">8.4</span> Facet the plot</a></li>
  </ul></li>
  <li><a href="#class-survey" id="toc-class-survey" class="nav-link" data-scroll-target="#class-survey"><span class="header-section-number">9</span> CLASS SURVEY</a></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Lab 02 - Visualizing data on COVID-19 in the U.S.</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Your Name HERE </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">January 24, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<style>
div.blue { background-color:#e6f0ff; border-radius: 5px; padding: 20px;}
</style>
<section id="overview" class="level1 unnumbered">
<h1 class="unnumbered">Overview</h1>
<p>Our goal for today is to reproduce this figure:</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pols1600.paultesta.org/labs/images/02_fig.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>I don’t expect anyone to be able to recite from memory the exact code, functions, and syntax to accomplish this task.</p>
<p>That said, you’ve already seen the code you need.</p>
<p>It’s available to you in multiple places like the slides (week 1 <a href="https://pols1600.paultesta.org/slides/01-slides.html#1">here</a>, week 2 <a href="https://pols1600.paultesta.org/slides/02-slides.html">here</a>) and last week’s <a href="https://pols1600.paultesta.org/labs/01-lab-comments.html">labs</a></p>
<p>My hope is that this lab will help you do the following:</p>
<ul>
<li><strong>Chunk big tasks into smaller concrete steps</strong>
<ul>
<li>Learn how to take a complex problem (“How do I produce a figure that shows the average rate of new cases per month for states with a particular type of face mask policy”) which you may think you have no idea how to do and break this challenge down into concrete tasks which you do know how do (“Well first, I’ll need to load some packages to work with and visualize data. Then, I’ll need to get the data. And then…”)</li>
</ul></li>
<li><strong>Think and write programmatically</strong>
<ul>
<li>In this .Rmd file, I’ll first ask you to outline, conceptually, all the steps you’ll need to do to produce this figure.</li>
<li>Don’t worry if you can’t think of all the necessary steps or aren’t sure of the order. We’ll produce a collective outline of what we need to do before getting to the actual coding</li>
<li>When we do code, I’ll ask you to organize your code as outlined below:
<ul>
<li>Separate your steps into sections using the <code>#</code> headers in Markdown</li>
<li>Write a brief overview in words that a normal human can understand, what the code in that section is doing</li>
<li>Paste the code for that section into a code chunk</li>
<li>Add brief comments to this code to help your reader understand what’s happening</li>
<li>Knit your document after completing each section.</li>
</ul></li>
</ul></li>
<li><strong>Mapping concepts to code</strong>
<ul>
<li>Again you shouldn’t have to write much code. Just copy and paste from the labs and slides.</li>
<li>Your goal for today is to interpret that code and develop a mental map that allows you to say when I want to do this type of task (say “recode data”), I need to use some combination of these functions (<code>%&gt;%</code>, <code>mutate()</code>, maybe <code>group_by()</code> or <code>case_when()</code>)</li>
<li>But shouldn’t we be writing our own code?! Yes. Sure. Eventually.</li>
<li>The tutorials give you practice writing single commands, and by the end of the class you should be able write this code like this for to accomplish similar tasks</li>
<li>But even then, you will not be writing code from memory. I still have to Google functions, and often search my old code to find a clever solution to task.</li>
<li>Everyone starts learning to code by copying and pasting other people’s code.</li>
<li>This will help minimize (but not eliminate) syntactic errors, while over time we get better writing code from scratch and fixing errors as the develop.</li>
</ul></li>
<li><strong>Practice wrangling data</strong>
<ul>
<li>How do you load data?</li>
<li>How do you look at data?</li>
<li>How do you transform data?</li>
</ul></li>
<li><strong>Practice visualizing data</strong>
<ul>
<li>Using the grammar of graphics to translate raw data into visual graphics</li>
<li>Understanding the components of this grammar:
<ul>
<li>data</li>
<li>aesthetics</li>
<li>geometries</li>
<li>facets</li>
<li>statistics</li>
<li>coordinates</li>
<li>themes</li>
</ul></li>
<li>Exploring what happens when we change these components</li>
</ul></li>
</ul>
<p>We’ll work in pairs and periodically check in as a class to check our progress, review concepts, and share insights.</p>
<p>For fun, let’s say that the first group that successfully recreates this figure gets to choose one of the following non-monetary prizes:</p>
<ul>
<li>I’ll tell them a joke</li>
<li>One AMA I will answer truthfully</li>
<li>One question to be asked on the weekly class survey</li>
<li>0.00001% extra credit added to their final grade for the course.</li>
</ul>
<p>If we finish early, you’re free to go. If you want, we can take some time to <a href="https://www.r-graph-gallery.com/index.html" target="_blank">explore some additional figures</a> we might produce like <a href="https://jtr13.github.io/cc19/different-ways-of-plotting-u-s-map-in-r.html" target="_blank">maps</a> or <a href="https://www.r-graph-gallery.com/lollipop-plot.html" target="_blank">lollipop</a> plots.</p>
<p>Ok, let’s begin!</p>
</section>
<section id="please-knit-this-.rmd-file" class="level1 unnumbered">
<h1 class="unnumbered">Please knit this .Rmd file</h1>
<p>For every lab:</p>
<ul>
<li>Download the file</li>
<li>Save it in your course folder</li>
<li>Knit the document</li>
<li>Open the html file in your browser (Easier to read)</li>
<li>Knit the document again after completing a section or chunk (Error checking)</li>
<li>Upload the final lab to <a href="https://canvas.brown.edu/courses/1087979/assignments/7870521?module_item_id=10762395" target="_blank">Canvas</a>.</li>
</ul>
</section>
<section id="describe-the-components-of-the-figure-youre-trying-to-reprodce" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Describe the components of the figure you’re trying to reprodce</h1>
<p>Recall, that we need <code>data</code>, <code>aesthetic</code> mappings and <code>geometries</code> to produce a figure</p>
<ul>
<li>What are the aesthetic mappings in this plot
<ul>
<li><code>x</code> average number of new cases per capita by month and policy</li>
<li><code>y</code> a variable indexing year and month</li>
<li><code>col</code> a variable indexing the face mask policy in place</li>
</ul></li>
<li>What is the geometry?
<ul>
<li>points using <code>geom_point()</code></li>
</ul></li>
<li>What is the data set used? (Hint it’s a transformation of <code>covid_us</code>)
<ul>
<li>From the comments to last week’s lab, I know I need to produce something like <code>cases_by_month_and_policy</code> from the <code>covid_us</code> data</li>
</ul></li>
</ul>
</section>
<section id="outline-the-steps-you-will-need-to-complete-this-process" class="level1 unnumbered">
<h1 class="unnumbered">Outline the steps you will need to complete this process</h1>
<ol type="1">
<li>Set up our work space</li>
<li>Download the COVID-19 data</li>
<li>Get a high level overview of the data</li>
<li>Recode the data</li>
<li>Calculate the average number of new cases in a given month for states with a given policy on face masks</li>
<li>Produce an initial figure</li>
<li>Refine the figure</li>
</ol>
</section>
<section id="set-up-our-workspace" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Set up our workspace</h1>
<p>First we need to get R ready to work by loading (and if need installing) any packages that we will be using.</p>
<p>From Tuesday’s <a href="https://pols1600.paultesta.org/slides/02-slides.html#8" target="_blank">slides</a> I will</p>
<section id="create-an-object-listing-all-the-packages-i-will-use-today" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="create-an-object-listing-all-the-packages-i-will-use-today"><span class="header-section-number">2.1</span> Create an object listing all the packages I will use today</h2>
<p>This code creates a object called <code>the_packages</code> which contains a vector of character strings corresponding to the names of the packages I want to use today</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>the_packages <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="do">## R Markdown</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"tinytex"</span>, <span class="st">"kableExtra"</span>,</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Tidyverse</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"tidyverse"</span>,<span class="st">"lubridate"</span>, <span class="st">"forcats"</span>, <span class="st">"haven"</span>,<span class="st">"labelled"</span>,</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Extensions for ggplot</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ggmap"</span>,<span class="st">"ggrepel"</span>, <span class="st">"ggridges"</span>, <span class="st">"ggthemes"</span>,<span class="st">"ggpubr"</span>,</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">"GGally"</span>,</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Data </span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"COVID19"</span>,<span class="st">"maps"</span>,<span class="st">"mapdata"</span>,<span class="st">"DT"</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="define-a-function-to-install-and-load-packages" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="define-a-function-to-install-and-load-packages"><span class="header-section-number">2.2</span> Define a function to install and load packages</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>ipak <span class="ot">&lt;-</span> <span class="cf">function</span>(pkg){</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    new.pkg <span class="ot">&lt;-</span> pkg[<span class="sc">!</span>(pkg <span class="sc">%in%</span> <span class="fu">installed.packages</span>()[, <span class="st">"Package"</span>])]</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(new.pkg)) </span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">install.packages</span>(new.pkg, <span class="at">dependencies =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sapply</span>(pkg, require, <span class="at">character.only =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="use-the-ipak-function-to-load-the-necessary-packages" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="use-the-ipak-function-to-load-the-necessary-packages"><span class="header-section-number">2.3</span> Use the ipak function to load the necessary packages</h2>
<p>Now I run the <code>ipak()</code> giving it the object <code>the_packages</code> as an input. It sorts through the packages, checks to see if they’re installed, if not installs them, and then loads all of the packages so I can use them.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ipak</span>(the_packages)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in contrib.url(repos, "source"): trying to use CRAN without setting a mirror</code></pre>
</div>
</div>
</section>
</section>
<section id="download-the-covid-19-data" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Download the COVID-19 data</h1>
<p>Now, I’ll use the <code>covid19()</code> function from the <code>COVID19</code> package to download the data for today</p>
<ul>
<li>The argument <code>country = 'US'</code> tells the function I want data from the US</li>
<li>The argument <code>level = 2</code> tells the function I want data at the second administrative level (States in the US)</li>
<li>The argument <code>verbose = F</code> tells the function to hide any messages the function might produce (in this case a progress bar telling me how the download is going)</li>
<li><code>covid &lt;- ...</code> Saves the output of <code>covid19()</code> into a data frame named <code>covid</code></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>covid <span class="ot">&lt;-</span> COVID19<span class="sc">::</span><span class="fu">covid19</span>(</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">country =</span> <span class="st">"US"</span>,</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">level =</span> <span class="dv">2</span>,</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> F</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="get-a-high-level-overview-of-the-data" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Get a high level overview of the data</h1>
<p>There are lots of ways to do this. At a minium</p>
<ul>
<li>Get a sense of the dimensions of the data:</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(covid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 80156    47</code></pre>
</div>
</div>
<ul>
<li>Take a look at the first few rows</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(covid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        id       date confirmed deaths recovered tests vaccines
1 10b692cc 2020-03-16        NA     NA        NA    NA       NA
2 10b692cc 2020-03-17        NA     NA        NA    NA       NA
3 10b692cc 2020-03-18        NA     NA        NA    NA       NA
4 10b692cc 2020-03-19        NA     NA        NA    NA       NA
5 10b692cc 2020-03-20        NA     NA        NA    NA       NA
6 10b692cc 2020-03-21        NA     NA        NA    NA       NA
  people_vaccinated people_fully_vaccinated hosp icu vent school_closing
1                NA                      NA   NA  NA   NA             NA
2                NA                      NA   NA  NA   NA             NA
3                NA                      NA   NA  NA   NA             NA
4                NA                      NA   NA  NA   NA             NA
5                NA                      NA   NA  NA   NA             NA
6                NA                      NA   NA  NA   NA             NA
  workplace_closing cancel_events gatherings_restrictions transport_closing
1                NA            NA                      NA                NA
2                NA            NA                      NA                NA
3                NA            NA                      NA                NA
4                NA            NA                      NA                NA
5                NA            NA                      NA                NA
6                NA            NA                      NA                NA
  stay_home_restrictions internal_movement_restrictions
1                     NA                             NA
2                     NA                             NA
3                     NA                             NA
4                     NA                             NA
5                     NA                             NA
6                     NA                             NA
  international_movement_restrictions information_campaigns testing_policy
1                                  NA                    NA             NA
2                                  NA                    NA             NA
3                                  NA                    NA             NA
4                                  NA                    NA             NA
5                                  NA                    NA             NA
6                                  NA                    NA             NA
  contact_tracing facial_coverings vaccination_policy elderly_people_protection
1              NA               NA                 NA                        NA
2              NA               NA                 NA                        NA
3              NA               NA                 NA                        NA
4              NA               NA                 NA                        NA
5              NA               NA                 NA                        NA
6              NA               NA                 NA                        NA
  government_response_index stringency_index containment_health_index
1                        NA               NA                       NA
2                        NA               NA                       NA
3                        NA               NA                       NA
4                        NA               NA                       NA
5                        NA               NA                       NA
6                        NA               NA                       NA
  economic_support_index administrative_area_level administrative_area_level_1
1                     NA                         2               United States
2                     NA                         2               United States
3                     NA                         2               United States
4                     NA                         2               United States
5                     NA                         2               United States
6                     NA                         2               United States
  administrative_area_level_2 administrative_area_level_3 latitude longitude
1    Northern Mariana Islands                        &lt;NA&gt; 14.15569  145.2119
2    Northern Mariana Islands                        &lt;NA&gt; 14.15569  145.2119
3    Northern Mariana Islands                        &lt;NA&gt; 14.15569  145.2119
4    Northern Mariana Islands                        &lt;NA&gt; 14.15569  145.2119
5    Northern Mariana Islands                        &lt;NA&gt; 14.15569  145.2119
6    Northern Mariana Islands                        &lt;NA&gt; 14.15569  145.2119
  population iso_alpha_3 iso_alpha_2 iso_numeric iso_currency key_local
1      55144         USA          US         840          USD        69
2      55144         USA          US         840          USD        69
3      55144         USA          US         840          USD        69
4      55144         USA          US         840          USD        69
5      55144         USA          US         840          USD        69
6      55144         USA          US         840          USD        69
  key_google_mobility       key_apple_mobility key_jhu_csse key_nuts key_gadm
1                &lt;NA&gt; Northern Mariana Islands         US69       NA      MNP
2                &lt;NA&gt; Northern Mariana Islands         US69       NA      MNP
3                &lt;NA&gt; Northern Mariana Islands         US69       NA      MNP
4                &lt;NA&gt; Northern Mariana Islands         US69       NA      MNP
5                &lt;NA&gt; Northern Mariana Islands         US69       NA      MNP
6                &lt;NA&gt; Northern Mariana Islands         US69       NA      MNP</code></pre>
</div>
</div>
<ul>
<li>Get a quick sense of the values of key variables to see if there’s any recoding you need to do (like with the negative values for <code>facial_coverings</code>)</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(covid<span class="sc">$</span>facial_coverings)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
   -4    -3    -2    -1     0     1     2     3     4 
  410  5897  7362   275  3893  8604 17424  9191   622 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(covid<span class="sc">$</span>confirmed)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    Min.  1st Qu.   Median     Mean  3rd Qu.     Max.     NA's 
       1    70784   351496   889830  1043231 12169158    18214 </code></pre>
</div>
</div>
</section>
<section id="recode-the-data" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Recode the data</h1>
<p>This is a complex task.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="https://pols1600.paultesta.org/labs/images/recode.jpeg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>So lets break it down conceptually. Roughly we’ll need to:</p>
<ul>
<li>Filter out U.S. territories</li>
<li>Create a variable called <code>state</code> from the <code>administrative_area_level_2</code> variable</li>
<li>Group by this state variable and calculate:
<ul>
<li>the number of new cases in a state on given day</li>
<li>the number of new cases in a state on given day per capita</li>
<li>the type of face mask policy in effect in a state.</li>
<li>A variable that contains just the year and month of a given observation</li>
</ul></li>
</ul>
<p>I’d probably use the code from the comments to <a href="https://pols1600.paultesta.org/labs/01-lab-comments.html#5_Replicate_the_data_cleaning_and_recoding_from_class" target="_blank">Lab 01</a> as my guide.</p>
<p>That code will also calculate the percentage of a state’s population that’s vaccinated, which might be interesting to explore later.</p>
<section id="filter-out-u.s.-territories" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="filter-out-u.s.-territories"><span class="header-section-number">5.1</span> Filter out U.S. Territories</h2>
<p>For simplicity, (and practice filtering observations), I’ve asked us to remove observations from U.S. territories.</p>
<p>The code below</p>
<ul>
<li>Creates an object called <code>us_territories</code>.</li>
<li>Use this object to filter out observations that are US territories</li>
<li>Creates a new data frame that is just observations from the 50 U.S. states. and D.C.</li>
<li>Checks that this recoding seems to have worked</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># U.S. Territories</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>territories <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"American Samoa"</span>,</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Guam"</span>,</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Northern Mariana Islands"</span>,</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Puerto Rico"</span>,</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Virgin Islands"</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter out U.S. Territories</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>covid_us <span class="ot">&lt;-</span> covid <span class="sc">%&gt;%</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>administrative_area_level_2 <span class="sc">%in%</span> territories)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in covid %&gt;% filter(!administrative_area_level_2 %in% territories): could not find function "%&gt;%"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check to make sure covid_us contains only 50 states and D.C.</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(covid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 80156    47</code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(covid_us)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in eval(expr, envir, enclos): object 'covid_us' not found</code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(<span class="fu">unique</span>(covid<span class="sc">$</span>administrative_area_level_2)) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 56</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(<span class="fu">unique</span>(covid_us<span class="sc">$</span>administrative_area_level_2)) <span class="sc">==</span> <span class="dv">51</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in eval(expr, envir, enclos): object 'covid_us' not found</code></pre>
</div>
</div>
</section>
<section id="create-a-state-variable" class="level2" data-number="5.2">
<h2 data-number="5.2" class="anchored" data-anchor-id="create-a-state-variable"><span class="header-section-number">5.2</span> Create a <code>state</code> variable</h2>
<p>This is purely for convenience, because typing <code>administrative_area_level_2</code> is annoying. The code copies the values of this variable into a new variable called <code>state</code> using the <code>mutate()</code> function.</p>
<p>Mutate returns the original data frame plus the new column. We have to save this output for our our changes to persist (i.e.&nbsp;we have to assign the output of <code>mutate()</code> back into <code>covid_us</code>)</p>
<p>In last week’s lab, I just <code>piped</code> the output to the next command, did some more recoding with mutate, and then finally saved the output back into <code>covid_us</code>. In this lab, I’ll save the output after each step.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>covid_us <span class="sc">%&gt;%</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">state =</span> administrative_area_level_2,</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  ) <span class="ot">-&gt;</span> covid_us</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in covid_us %&gt;% mutate(state = administrative_area_level_2, ): could not find function "%&gt;%"</code></pre>
</div>
</div>
</section>
<section id="group-by-the-state-variable-to-calculate-new-covid-19-cases" class="level2" data-number="5.3">
<h2 data-number="5.3" class="anchored" data-anchor-id="group-by-the-state-variable-to-calculate-new-covid-19-cases"><span class="header-section-number">5.3</span> Group by the <code>state</code> variable to calculate new Covid-19 cases</h2>
<p>Now I use this shorter variable <code>state</code> to calculate the number of new cases (<code>new_cases</code>) in a given state on a given date, and rescale this variable so that it’s expressed in terms of new cases per 100,000 residents.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>covid_us <span class="sc">%&gt;%</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(state) <span class="sc">%&gt;%</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">new_cases =</span> confirmed <span class="sc">-</span> <span class="fu">lag</span>(confirmed),</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">new_cases_pc =</span> new_cases <span class="sc">/</span> population <span class="sc">*</span><span class="dv">100000</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    ) <span class="ot">-&gt;</span> covid_us</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in covid_us %&gt;% dplyr::group_by(state) %&gt;% mutate(new_cases = confirmed - : could not find function "%&gt;%"</code></pre>
</div>
</div>
<p>The slides from Tuesday, helped demonstrate what this code was doing, and why we wanted to group by state.</p>
<p>Here’s an example for a subset of the data from April 1, 2020 to April 7, 2020</p>
<p>We see that the <code>lag()</code> function simply moves the observation of a variable “up” one row so that we can take the difference between the total number of cases in a state on one date and the total number of cases on the date before, to calculate the number of <em>new</em> cases</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>covid_us <span class="sc">%&gt;%</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(date <span class="sc">&gt;=</span> <span class="st">"2020-04-01"</span> <span class="sc">&amp;</span> date <span class="sc">&lt;</span> <span class="st">"2020-04-07"</span>)<span class="sc">%&gt;%</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(state) <span class="sc">%&gt;%</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(state, date, confirmed)<span class="sc">%&gt;%</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">confirmed_lag1 =</span> <span class="fu">lag</span>(confirmed),</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">new_cases =</span> confirmed <span class="sc">-</span> <span class="fu">lag</span>(confirmed)</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in covid_us %&gt;% filter(date &gt;= "2020-04-01" &amp; date &lt; "2020-04-07") %&gt;% : could not find function "%&gt;%"</code></pre>
</div>
</div>
<p>If we hadn’t grouped by state, then when we lagged the <code>confirmed</code> variable, R thinks the number of confirmed cases in California before April 1, 2020, is 986 which is actually the number of cases in Minnesota on April 7, 2020</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>covid_us <span class="sc">%&gt;%</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(date <span class="sc">&gt;=</span> <span class="st">"2020-04-01"</span> <span class="sc">&amp;</span> date <span class="sc">&lt;</span> <span class="st">"2020-04-07"</span>)<span class="sc">%&gt;%</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(state, date, confirmed)<span class="sc">%&gt;%</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">confirmed_lag1 =</span> <span class="fu">lag</span>(confirmed),</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">new_cases =</span> confirmed <span class="sc">-</span> <span class="fu">lag</span>(confirmed)</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in covid_us %&gt;% filter(date &gt;= "2020-04-01" &amp; date &lt; "2020-04-07") %&gt;% : could not find function "%&gt;%"</code></pre>
</div>
</div>
</section>
<section id="recode-the-facial_coverings-variable" class="level2" data-number="5.4">
<h2 data-number="5.4" class="anchored" data-anchor-id="recode-the-facial_coverings-variable"><span class="header-section-number">5.4</span> Recode the <code>facial_coverings</code> variable</h2>
<p>Next we use the <code>case_when()</code> function inside the <code>mutate()</code> function to create a variable called <code>face_masks</code> based on the values of the <code>facial_coverings</code> variable in the data.</p>
<p><code>case_when()</code> when uses R’s ability to make logical comparisons. When the variable <code>facial_coverings</code> equals 0, R will input the character string <code>"No policy"</code> into the <code>face_masks</code> variable.</p>
<p>When the absolute value of <code>facial_coverings</code> equals 1 (i.e.<code>facial_coverings</code> equals 1 or -1 ), R will input the character string <code>"Recommended"</code> into the <code>face_masks</code> variable. And so on.</p>
<p>We use the <code>abs()</code> function to take the absolute value of the <code>facial_coverings</code> variable because codebook for these data implied:</p>
<blockquote class="blockquote">
<p>In short: positive integers identify policies applied to the entire administrative area. Negative integers are used to identify policies that represent a best guess of the policy in force, but may not represent the real status of the given area. The negative sign is used solely to distinguish the two cases, it should not be treated as a real negative value.</p>
</blockquote>
<p>We know from last weeks lab, that negative values in the U.S. typically seem to be cases where a city had a more stringent policy than the state (e.g.&nbsp;Chicago adopts more stringent face mask policies than Illinois).</p>
<p>Finally, we put a <code>%&gt;%</code> after the output of <code>case_when()</code> and pass it’s output to the <code>factor()</code> function.</p>
<p>The <code>.</code> acts as sort of placeholder, <code>factor()</code> expects some input here (like a variable from a data frame), <code>.</code> tells R to use the output of <code>case_when()</code>.</p>
<p>The <code>levels =</code> then transforms the character data produced by <code>case_when()</code> into a <code>factor</code> with an implicit ordering of levels (i.e.&nbsp;“No policy” &lt; “Recommended”&lt; “Some requirements” &lt;“Required shared places” &lt;“Required all times”) which turns out to be useful trick for organizing how data are plotted and visualized.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>covid_us <span class="sc">%&gt;%</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">face_masks =</span> <span class="fu">case_when</span>(</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>      facial_coverings <span class="sc">==</span> <span class="dv">0</span> <span class="sc">~</span> <span class="st">"No policy"</span>,</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">abs</span>(facial_coverings) <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"Recommended"</span>,</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">abs</span>(facial_coverings) <span class="sc">==</span> <span class="dv">2</span> <span class="sc">~</span> <span class="st">"Some requirements"</span>,</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">abs</span>(facial_coverings) <span class="sc">==</span> <span class="dv">3</span> <span class="sc">~</span> <span class="st">"Required shared places"</span>,</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">abs</span>(facial_coverings) <span class="sc">==</span> <span class="dv">4</span> <span class="sc">~</span> <span class="st">"Required all times"</span>,</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> <span class="fu">factor</span>(.,</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"No policy"</span>,<span class="st">"Recommended"</span>,</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"Some requirements"</span>,</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"Required shared places"</span>,</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"Required all times"</span>)</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>    ) </span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>    ) <span class="ot">-&gt;</span> covid_us</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in covid_us %&gt;% mutate(face_masks = case_when(facial_coverings == : could not find function "%&gt;%"</code></pre>
</div>
</div>
</section>
<section id="create-a-variable-capturing-the-year-and-month-of-the-observation" class="level2" data-number="5.5">
<h2 data-number="5.5" class="anchored" data-anchor-id="create-a-variable-capturing-the-year-and-month-of-the-observation"><span class="header-section-number">5.5</span> Create a variable capturing the year and month of the observation</h2>
<p>Finally we create some variables that extract components of an observation’s date:</p>
<ul>
<li><code>year = year(date)</code> returns just the year from a variable of class <code>Date</code></li>
<li><code>month = month(date)</code> returns just the month from a variable of class <code>Date</code></li>
<li><code>year_month = paste(year, str_pad(month, width = 2, pad=0), sep = "-")</code> pastes these to variables together.</li>
<li><code>str_pad(month, width = 2, pad=0)</code> adds a leading 0 to any month with only 1 digit, to ensure that all the months have 2 characters.</li>
</ul>
<p>The code from your lab also calculates the percent of a states population that is vaccinated, which isn’t strictly needed for today.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>covid_us <span class="sc">%&gt;%</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">year =</span> <span class="fu">year</span>(date),</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">month =</span> <span class="fu">month</span>(date),</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">year_month =</span> <span class="fu">paste</span>(year, <span class="fu">str_pad</span>(month, <span class="at">width =</span> <span class="dv">2</span>, <span class="at">pad=</span><span class="dv">0</span>), <span class="at">sep =</span> <span class="st">"-"</span>),</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">percent_vaccinated =</span> people_fully_vaccinated<span class="sc">/</span>population<span class="sc">*</span><span class="dv">100</span>  </span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    ) <span class="ot">-&gt;</span> covid_us</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in covid_us %&gt;% mutate(year = year(date), month = month(date), year_month = paste(year, : could not find function "%&gt;%"</code></pre>
</div>
</div>
<p>Creating separte <code>year</code> and <code>month</code> variables aren’t strictly necessary,</p>
<p>We could have written something like:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>covid_us <span class="sc">%&gt;%</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">year_month =</span> <span class="fu">paste</span>(<span class="fu">year</span>(date), <span class="fu">str_pad</span>(<span class="fu">month</span>(date), <span class="at">width =</span> <span class="dv">2</span>, <span class="at">pad=</span><span class="dv">0</span>), <span class="at">sep =</span> <span class="st">"-"</span>),</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">percent_vaccinated =</span> people_fully_vaccinated<span class="sc">/</span>population<span class="sc">*</span><span class="dv">100</span>  </span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    ) <span class="ot">-&gt;</span> covid_us</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>But that <code>year_month</code> line was already feeling kind of clunky, and maybe we’ll want the <code>year</code> and <code>month</code> variables later.</p>
</section>
</section>
<section id="calculate-the-average-number-of-new-cases-in-a-given-month-for-states-with-a-given-policy-on-face-mask" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Calculate the average number of new cases in a given month for states with a given policy on face mask</h1>
<ul>
<li>To calculate averages, we’ll use the <code>mean()</code> function</li>
<li>To calculate averages separately by month and year and by type of face mask policy, we’ll use the <code>group_by()</code> function.</li>
<li>To make these values more legible, we’ll round them to integers</li>
<li>To count the total number of states with a given policy in a given month, we’ll use the unique command to return a string with the list unique names of states with say Recommended face mask policies in a month (e.g.&nbsp;April 2020), and the <code>length()</code> command to count up how many states.</li>
<li>Finally we’ll save the output of this collection of code to an object called <code>cases_by_month_and_policy</code> which we’ll use to produce our figure.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Data</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>covid_us <span class="sc">%&gt;%</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Exclude observations with missing values on face_masks</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(face_masks))<span class="sc">%&gt;%</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate summaries separately by Year-Month and face-mask policy</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(year_month,face_masks) <span class="sc">%&gt;%</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Summaries</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Total number of observations</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">length</span>(<span class="fu">unique</span>(state)),</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Average number of cases per capita</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">new_cases_pc =</span> <span class="fu">round</span>(<span class="fu">mean</span>(new_cases_pc,<span class="at">na.rm=</span>T)),</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Average number of total cases</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_cases =</span> <span class="fu">round</span>(<span class="fu">mean</span>(confirmed,<span class="at">na.rm=</span>T))</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>  ) <span class="ot">-&gt;</span> cases_by_month_and_policy</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in covid_us %&gt;% filter(!is.na(face_masks)) %&gt;% group_by(year_month, : could not find function "%&gt;%"</code></pre>
</div>
</div>
</section>
<section id="reproduce-the-figure-from-lab-01" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> Reproduce the figure from Lab 01</h1>
<p>Finally use <code>cases_by_month_and_policy</code> data frame to create a figure.</p>
<p>Recalling our <strong>grammar of graphics</strong>:</p>
<ul>
<li><code>data</code> = <code>cases_by_month_and_policy</code></li>
<li><code>ggplot(...)</code> initializes the plotting environment</li>
<li><code>aes()</code> maps variables in <code>cases_by_month_and_policy</code> to <code>aesthetic</code> features of the graph:
<ul>
<li><code>x= year_month</code> says to use values of <code>year_month</code> column on the x axis</li>
<li><code>y = new_cases_pc</code> says use values from the <code>new_cases_pc</code> on the y axis</li>
<li><code>col=face_masks</code> says to use a unique color each value of <code>face_masks</code> column</li>
</ul></li>
<li><code>geom_point()</code> says to plot points using the aesthetic mappings we defined in <code>ggplot</code> with the <code>aes()</code> function</li>
<li><code>coord_flip()</code> flips the coordinates of the plot so that the values of x axis are now on the y axis, and the values of the y axis are now on the x axis.</li>
<li>Finally <code>-&gt; fig1</code> saves the output of this code to an object called <code>fig1</code>. Writing this object on it’s own line will display the figure. Saving the our figure as an object will allow us to update it</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Data</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>cases_by_month_and_policy <span class="sc">%&gt;%</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Aesthetics</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">x=</span> year_month,</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> new_cases_pc,</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">col=</span>face_masks)</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>    )<span class="sc">+</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Geometries</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>()<span class="sc">+</span></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Coordinates</span></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="ot">-&gt;</span> fig1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in cases_by_month_and_policy %&gt;% ggplot(aes(x = year_month, y = new_cases_pc, : could not find function "%&gt;%"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>fig1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in eval(expr, envir, enclos): object 'fig1' not found</code></pre>
</div>
</div>
</section>
<section id="optional-refine-the-figure" class="level1" data-number="8">
<h1 data-number="8"><span class="header-section-number">8</span> Optional: Refine the figure</h1>
<p>Let’s see if we can improve this figure by:</p>
<ul>
<li>Adding meaningful labels and a title</li>
<li>Changing the theme</li>
<li>Changing the size of the points to reflect the total number of states with a policy in that month</li>
<li>Faceting our plot by face mask policy</li>
</ul>
<section id="adding-meaningful-labels-and-title" class="level2" data-number="8.1">
<h2 data-number="8.1" class="anchored" data-anchor-id="adding-meaningful-labels-and-title"><span class="header-section-number">8.1</span> Adding meaningful labels and title</h2>
<p>Because we saved the output of our <code>ggplot</code> to an object called <code>fig1</code> we can add additional commands to this object using the <code>+</code> without having to rewrite all the code.</p>
<p>First let’s add better labels to the graph.</p>
<ul>
<li>Note that even though we flipped the coordinates, the <code>aes</code> aesthetic mappings stay the same. So to change the label of the figures y-axis to “Date” we change the label of <code>x = "Date"</code></li>
<li><code>ggplot</code> automatically generates a legend for aesthetic mappings like <code>color</code> We can add a line break using the the special character <code>\n</code> in our code</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>fig1 <span class="sc">+</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Date"</span>,</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Average number of new cases (per 100k)"</span>,</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">col =</span> <span class="st">"Face Mask</span><span class="sc">\n</span><span class="st"> Policy"</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in eval(expr, envir, enclos): object 'fig1' not found</code></pre>
</div>
</div>
<p>Note the code above didn’t update <code>fig1</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>fig1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in eval(expr, envir, enclos): object 'fig1' not found</code></pre>
</div>
</div>
<p>We have to save the output (if we like it) for our changes to persist.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>fig1 <span class="sc">+</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Date"</span>,</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Average number of new cases (per 100k)"</span>,</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">col =</span> <span class="st">"Face Mask</span><span class="sc">\n</span><span class="st">Policy"</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="ot">-&gt;</span> fig1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in eval(expr, envir, enclos): object 'fig1' not found</code></pre>
</div>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>fig1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in eval(expr, envir, enclos): object 'fig1' not found</code></pre>
</div>
</div>
</section>
<section id="changing-the-theme-of-the-plot" class="level2" data-number="8.2">
<h2 data-number="8.2" class="anchored" data-anchor-id="changing-the-theme-of-the-plot"><span class="header-section-number">8.2</span> Changing the theme of the plot</h2>
<p>Here’s an example of some different themes</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Black and white</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>fig1 <span class="sc">+</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in eval(expr, envir, enclos): object 'fig1' not found</code></pre>
</div>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Minimal</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>fig1 <span class="sc">+</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in eval(expr, envir, enclos): object 'fig1' not found</code></pre>
</div>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Classic</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>fig1 <span class="sc">+</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in eval(expr, envir, enclos): object 'fig1' not found</code></pre>
</div>
</div>
<p>This is pretty personal, and depends of the figure itself. I like a white background and some guide lines:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>fig1 <span class="sc">+</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="ot">-&gt;</span> fig1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in eval(expr, envir, enclos): object 'fig1' not found</code></pre>
</div>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>fig1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in eval(expr, envir, enclos): object 'fig1' not found</code></pre>
</div>
</div>
</section>
<section id="make-the-size-of-the-dots-reflect-the-number-of-states-with-this-policy" class="level2" data-number="8.3">
<h2 data-number="8.3" class="anchored" data-anchor-id="make-the-size-of-the-dots-reflect-the-number-of-states-with-this-policy"><span class="header-section-number">8.3</span> Make the size of the dots reflect the number of states with this policy</h2>
<p>In the <code>cases_by_month_and_policy</code> we have a column called <code>n</code> which is the number of states which had a given policy in a given month.</p>
<p>We can add an aesthetic to our plot that varies the size of the points by the number of states.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>fig1 <span class="sc">+</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">size =</span> n) <span class="ot">-&gt;</span> fig1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in eval(expr, envir, enclos): object 'fig1' not found</code></pre>
</div>
</div>
<p>We call this type of plot a <a href="https://www.r-graph-gallery.com/bubble-chart.html">bubble plot</a>{target=“_blank”</p>
<p>I have mixed feelings about multiple legends. We can remove the legend for size using the <code>scale_size()</code> function. I had to Google how to do this for the millionth time.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>fig1 <span class="sc">+</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_size</span>(<span class="at">guide =</span> <span class="st">"none"</span>) <span class="ot">-&gt;</span> fig1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in eval(expr, envir, enclos): object 'fig1' not found</code></pre>
</div>
</div>
</section>
<section id="facet-the-plot" class="level2" data-number="8.4">
<h2 data-number="8.4" class="anchored" data-anchor-id="facet-the-plot"><span class="header-section-number">8.4</span> Facet the plot</h2>
<p>Varying the size of the dots by the number of states conveys more information. But makes the chart a little harder to read. Dots overlap.</p>
<p>The <code>facet_wrap</code> command will produce separate bubble plots for each level of the “facetting” variable, in this case `face_masks</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>fig1 <span class="sc">+</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>face_masks) <span class="ot">-&gt;</span> fig1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in eval(expr, envir, enclos): object 'fig1' not found</code></pre>
</div>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>fig1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in eval(expr, envir, enclos): object 'fig1' not found</code></pre>
</div>
</div>
<p>Now I think also want a second legend for the number of states</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>fig1 <span class="sc">+</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_size</span>(<span class="at">guide =</span> <span class="st">"legend"</span>)<span class="sc">+</span></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="st">"# of States</span><span class="sc">\n</span><span class="st">with Policy"</span></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>  )<span class="ot">-&gt;</span> fig1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in eval(expr, envir, enclos): object 'fig1' not found</code></pre>
</div>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>fig1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in eval(expr, envir, enclos): object 'fig1' not found</code></pre>
</div>
</div>
<p>This seems pretty good if our goal was to show in general terms</p>
<ul>
<li>It shows the average number new cases for states with a given face mask policy over time.</li>
<li>It shows how the mix of types of face mask policies states have adopted has changed over time</li>
</ul>
<p>If our goal was to make comparisons across face mask policies over a given time period, I’m might still prefer something closer to our original graph.</p>
</section>
</section>
<section id="class-survey" class="level1" data-number="9">
<h1 data-number="9"><span class="header-section-number">9</span> CLASS SURVEY</h1>
<p>Finally, please take a moment to complete this week’s <a href="https://brown.co1.qualtrics.com/jfe/form/SV_cYlY1R3DBzmFthI">class survey</a></p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>