{
  "hash": "b73eef4f9a2830ebf99db44692cc1d0c",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: 'Lab 08 - Replicating Grumbach and Hill (2022):'\nsubtitle: \"Reproducing the results\"\nauthor: \"P.F. Testa\"\ndate: \"Last Updated 2024-03-14\"\nformat:\n  html:\n    toc: true\n    toc-location: right\n    toc-float: true\n    toc-depth: 2\n    number-sections: true\nexecute: \n  eval: true\n  echo: true\n  warning: false\n  message: false\n  cache: true\n---\n\n\n\n# Overview {.unnumbered}\n\nIn this lab, we continue our replication of Grumbach and Hill (2021) \"Rock the Registration: Same Day Registration Increases Turnout of Young Voters.\"\n\nTo accomplish this we will:\n\n0. Load packages and set the working directory to **where this file is saved**. (5 minutes)\n\n1. **Summarize the study** in terms of it's research question, theory, design, and results. (10 minutes)\n\n2. Download the replication files and **save them in the same folder as this lab** (5 minutes)\n\n3. **Load the data** from your computers into R (5 minutes)\n\n4. Get a quick **HLO** of the data (10 minutes)\n\n5. **Merge** data on election policy into data on voting (5 minutes, together),\n\n6. **Recode** the covariates, key predictors, and outcome for the study (10 minutes, partly together)\n\n7. Recreate **Figure 1** (15 minutes)\n\n8. Recreate **Figure 2** (15 minutes)\n\nFinally, we'll take the weekly survey which should be a **fun** one\n\nOne of these 8 tasks will be randomly selected as the graded question for the lab.\n\nYou will work in your assigned groups. Only one member of each group needs to submit the html file of lab.\n\nThis lab **must** contain the names of the group members in attendance.\n\nIf you are attending remotely, you will submit your labs individually.\n\nHere are your assigned groups for the semester.\n\n\n::: {.cell}\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"datatables html-widget html-fill-item\" id=\"htmlwidget-7ba352e197bcaae27c75\" style=\"width:100%;height:auto;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-7ba352e197bcaae27c75\">{\"x\":{\"filter\":\"none\",\"vertical\":false,\"data\":[[\"1\",\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\"],[\"Group 1\",\"Group 2\",\"Group 3\",\"Group 4\",\"Group 5\",\"Group 6\",\"Group 7\",\"Group 8\"],[\"Maia Eng\",\"Andrew Rovinsky\",\"Serafym Rybachkivskyi\",\"Tiffany Eddy\",\"Christopher Maron\",\"Mia Hamilton\",\"Mariana Melzer\",\"Logan Szittai\"],[\"Guadalupe Herrera\",\"Spencer Lorin\",\"Rachel Kim\",\"Daniel Solomon\",\"Daniel Baker\",\"Emily Colon\",\"Kahrie Langham\",\"Keiley Thompson\"],[\"Stephen Robinson\",\"Lucinda Anderson\",\"Kai Blades\",\"Zoe Smith\",\"Neve Diaz-Carr\",\"Davis Kelly\",\"Shannon Feerick-Hillenbrand\",\"Lydell Dyer\"],[\"Jeremiah Harrington\",\"Serenity Hamilton\",\"Emma Coleman\",\"Lorena Calderon\",\"Olivia Hanley\",\"Talia Levine\",\"Jarret Fernandes\",\"Mahir Arora\"]],\"container\":\"<table class=\\\"display\\\">\\n  <thead>\\n    <tr>\\n      <th> <\\/th>\\n      <th>Group<\\/th>\\n      <th>1<\\/th>\\n      <th>2<\\/th>\\n      <th>3<\\/th>\\n      <th>4<\\/th>\\n    <\\/tr>\\n  <\\/thead>\\n<\\/table>\",\"options\":{\"columnDefs\":[{\"orderable\":false,\"targets\":0},{\"name\":\" \",\"targets\":0},{\"name\":\"Group\",\"targets\":1},{\"name\":\"1\",\"targets\":2},{\"name\":\"2\",\"targets\":3},{\"name\":\"3\",\"targets\":4},{\"name\":\"4\",\"targets\":5}],\"order\":[],\"autoWidth\":false,\"orderClasses\":false}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n\n# Goals {.unnumbered}\n\nThis week's lab will give you practice:\n\n- Summarizing academic work (Q1)\n\n- Loading data into R from your own computer (rather than just downloading it from the web) (Q2-3)\n\n- Looking at new data and figuring out what you need to do (e.g. merging, recoding) before you can analyze it (Q4-6)\n\n- Creating and interpreting figures that summarize aspects of a study's design and data (Q7-8)\n\nNext week, we'll get into the nuts and bolts of replicating Grumbach and Hill's main results\n\n\n# Workflow {.unnumbered}\n\n## Please render this .qmd file {.unnumbered}\n\nAs with every lab, you should:\n\n-   Download the file\n-   Save it in your course folder\n-   **Update the `author:` section of the YAML header to include the names of your group members in attendance.**\n-   Render the document\n-   Open the html file in your browser (Easier to read)\n-   Write your code in the **chunks provided under each section**\n-   Comment out or delete any test code you do not need\n-   **Render the document again after completing a section or chunk** (Error checking)\n-   Upload the final lab to [Canvas](https://canvas.brown.edu/courses/1094972/assignments){target=\"_blank\"}.\n\n# Get set up to work{.unnumbered}\n\n## Load packages {.unnumbered}\n\n\nAs always, let's load the packages we'll need for today\n\n\n::: {.cell}\n\n```{.r .cell-code}\nthe_packages <- c(\n  ## R Markdown\n  \"kableExtra\",\"DT\",\"texreg\",\"htmltools\",\n  ## Tidyverse\n  \"tidyverse\", \"lubridate\", \"forcats\", \"haven\", \"labelled\",\n  ## Extensions for ggplot\n  \"ggmap\",\"ggrepel\", \"ggridges\", \"ggthemes\", \"ggpubr\", \n  \"GGally\", \"scales\", \"dagitty\", \"ggdag\", \"ggforce\",\n  # Data \n  \"COVID19\",\"maps\",\"mapdata\",\"qss\",\"tidycensus\", \"dataverse\",\n  \"janitor\",\n  # Analysis\n  \"DeclareDesign\", \"easystats\", \"zoo\",\"margins\",\n  \"modelsummary\", \"ggeffects\"\n)\n\n# Define function to load packages\nipak <- function(pkg){\n    new.pkg <- pkg[!(pkg %in% installed.packages()[, \"Package\"])]\n    if (length(new.pkg)) \n        install.packages(new.pkg, dependencies = TRUE)\n    sapply(pkg, require, character.only = TRUE)\n}\n\nipak(the_packages)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   kableExtra            DT        texreg     htmltools     tidyverse \n         TRUE          TRUE          TRUE          TRUE          TRUE \n    lubridate       forcats         haven      labelled         ggmap \n         TRUE          TRUE          TRUE          TRUE          TRUE \n      ggrepel      ggridges      ggthemes        ggpubr        GGally \n         TRUE          TRUE          TRUE          TRUE          TRUE \n       scales       dagitty         ggdag       ggforce       COVID19 \n         TRUE          TRUE          TRUE          TRUE          TRUE \n         maps       mapdata           qss    tidycensus     dataverse \n         TRUE          TRUE          TRUE          TRUE          TRUE \n      janitor DeclareDesign     easystats           zoo       margins \n         TRUE          TRUE          TRUE          TRUE          TRUE \n modelsummary     ggeffects \n         TRUE          TRUE \n```\n\n\n:::\n:::\n\n\n# Load the data\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Set working directory to source file location\n\n# Load data (assumes a file called `cps_clean.rda` is in the same folder as this lab)\n\n\n# # BACKUP: Uncomment if you're having trouble you can load a version of the data from the web:\nload(url(\"https://pols1600.paultesta.org/files/data/cps_clean.rda\"))\n```\n:::\n\n\n# Create addtional variables\n\n\n::: {.cell}\n\n```{.r .cell-code}\npresidential_elections <- seq(1980, 2016, by = 4)\n \ncps %>% \n  mutate(\n    st_f = factor(st),\n    year_f = factor(year),\n    election_type = ifelse(year %in% presidential_elections, \"General\",\"Midterm\"),\n    SDR = ifelse(sdr == 1, \"SDR\",\"non-SDR\"),\n    age_group = fct_relevel(age_group, \"65+\")\n  ) -> cps\n```\n:::\n\n\n\n# Describing variation by state, year, and age\n\n## State\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create dataframe of average voting rates by state\ncps %>% \n  group_by(st) %>% \n  summarise(\n    turnout = mean(dv_voted, na.rm=T)\n  ) %>% \n  mutate(\n    st = fct_reorder(st, turnout)\n    ) -> df_state\n\ndf_state %>% \n  ggplot(aes(turnout,st))+\n  geom_bar(stat = \"identity\")\n```\n\n::: {.cell-output-display}\n![](08-lab-comments_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n\n## Variation over time\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncps %>% \n  group_by(year, election_type ) %>%\n  summarise(\n    turnout = mean(dv_voted, na.rm=T)\n  ) -> year_df\n\nyear_df %>% \n  ggplot(aes(year, turnout)) +\n  geom_line() +\n  facet_grid(~election_type)\n```\n\n::: {.cell-output-display}\n![](08-lab-comments_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n\n## Variation over state and time\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncps %>% \n  group_by(year, st, election_type ) %>%\n  summarise(\n    turnout = mean(dv_voted, na.rm=T)\n  ) -> year_state_df\n\nyear_state_df %>% \n  ungroup() %>% \n  ggplot(aes(year, turnout, group=st)) +\n  geom_line()+\n  stat_smooth(geom = \"line\", col = \"red\",aes(group = NULL))+\n  facet_grid(~election_type)\n```\n\n::: {.cell-output-display}\n![](08-lab-comments_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n\n\n# Understanding Two-Way Fixed Effects Regression\n\n## Estimate a simple model\n\n::: {.cell}\n\n```{.r .cell-code}\nm1 <- lm_robust(dv_voted ~ sdr, \n                data = cps,\n                se_type = \"classical\")\nm2 <- lm_robust(dv_voted ~ sdr, \n                data = cps,\n                se_type = \"stata\",\n                fixed_effects = ~ st + year,\n                try_cholesky = T)\nm3 <- lm_robust(dv_voted ~ sdr,\n                data = cps,\n                fixed_effects = ~ st + year,\n                se_type = \"stata\",\n                clusters = st,\n                try_cholesky = T)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmodelsummary(list(m1,m2,m3))\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\">   </th>\n   <th style=\"text-align:center;\">  (1) </th>\n   <th style=\"text-align:center;\">   (2) </th>\n   <th style=\"text-align:center;\">   (3) </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> (Intercept) </td>\n   <td style=\"text-align:center;\"> 0.548 </td>\n   <td style=\"text-align:center;\">  </td>\n   <td style=\"text-align:center;\">  </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:center;\"> (0.000) </td>\n   <td style=\"text-align:center;\">  </td>\n   <td style=\"text-align:center;\">  </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> sdr </td>\n   <td style=\"text-align:center;\"> 0.062 </td>\n   <td style=\"text-align:center;\"> 0.007 </td>\n   <td style=\"text-align:center;\"> 0.007 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;box-shadow: 0px 1.5px\">  </td>\n   <td style=\"text-align:center;box-shadow: 0px 1.5px\"> (0.001) </td>\n   <td style=\"text-align:center;box-shadow: 0px 1.5px\"> (0.002) </td>\n   <td style=\"text-align:center;box-shadow: 0px 1.5px\"> (0.014) </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Num.Obs. </td>\n   <td style=\"text-align:center;\"> 1988501 </td>\n   <td style=\"text-align:center;\"> 1988501 </td>\n   <td style=\"text-align:center;\"> 1988501 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> R2 </td>\n   <td style=\"text-align:center;\"> 0.002 </td>\n   <td style=\"text-align:center;\"> 0.028 </td>\n   <td style=\"text-align:center;\"> 0.028 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> R2 Adj. </td>\n   <td style=\"text-align:center;\"> 0.002 </td>\n   <td style=\"text-align:center;\"> 0.028 </td>\n   <td style=\"text-align:center;\"> 0.028 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> AIC </td>\n   <td style=\"text-align:center;\"> 2859151.1 </td>\n   <td style=\"text-align:center;\"> 2804888.5 </td>\n   <td style=\"text-align:center;\"> 2804888.5 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> BIC </td>\n   <td style=\"text-align:center;\"> 2859188.6 </td>\n   <td style=\"text-align:center;\"> 2804913.5 </td>\n   <td style=\"text-align:center;\"> 2804913.5 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> RMSE </td>\n   <td style=\"text-align:center;\"> 0.50 </td>\n   <td style=\"text-align:center;\"> 0.49 </td>\n   <td style=\"text-align:center;\"> 0.49 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Std.Errors </td>\n   <td style=\"text-align:center;\">  </td>\n   <td style=\"text-align:center;\">  </td>\n   <td style=\"text-align:center;\"> by: st </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n\n\n\n# Replicate two models from Figure 3\n\n\n::: {.cell}\n\n```{.r .cell-code}\nm1gh <- lm_robust(dv_voted ~ sdr*age_group, \n                  data = cps,\n                  fixed_effects = ~ st + year,\n                  se_type = \"stata\",\n                  clusters = st,\n                  try_cholesky = T\n                  )\n\n\nm2gh <- lm_robust(dv_voted ~ sdr*age_group +\n                    factor(race) + sex + faminc + educ, \n                  data = cps,\n                  fixed_effects = ~ st + year,\n                  se_type = \"stata\",\n                  clusters = st,\n                  try_cholesky = T\n                  )\n```\n:::\n\n\n## Marginal Effects of Interactions\n\n\n::: {.cell}\n\n```{.r .cell-code}\nme_fn <- function(mod, cohort, ci=0.95){\n  # Confidence Level for CI\n  alpha <- 1-ci\n  z <- qnorm(1-alpha/2)\n  \n  # Age (Always one for indicator of specific cohort)\n  age <- 1\n  \n  # Variance Covariance Matrix from Model\n  cov <- vcov(mod)\n  \n  # coefficient for SDR (Marginal Effect for reference category: 65+)\n  b1 <- coef(mod)[\"sdr\"]\n  \n  # If age is one of the interactions\n  if(cohort %in% c(\"18-24\",\"25-34\",\"35-44\",\"45-54\",\"55-64\")){\n    # get the name of the specific interaction\n    the_int <- paste(\"sdr:age_group\",cohort,sep=\"\")\n    # the coefficient on the interaction\n    b2 <- coef(mod)[the_int]\n    # Calculate marginal effect for age cohort\n    me <- b1 + b2*age\n    me_se <- sqrt(cov[\"sdr\",\"sdr\"] + age^2*cov[the_int,the_int] + 2*age*cov[\"sdr\",the_int])\n    ll <- me - z*me_se\n    ul <- me + z*me_se\n  }\n  if(!cohort %in% c(\"18-24\",\"25-34\",\"35-44\",\"45-54\",\"55-64\")){\n    me <- b1 \n    me_se <- mod$std.error[\"sdr\"]\n    ll <- mod$conf.low[\"sdr\"]\n    ul <- mod$conf.high[\"sdr\"]\n  }\n\n  res <- tibble(\n    Age = cohort,\n    Effect = me,\n    SE = me_se,\n    ll = ll,\n    ul = ul\n  )\n  return(res)\n\n\n}\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nthe_age_groups <- levels(cps$age_group)\n\nthe_age_groups %>% \n  purrr::map_df(~me_fn(m1gh, cohort=.)) %>% \n  mutate(\n    Age = factor(Age),\n    Model = \"No controls\"\n  ) -> fig3_no_controls\n\nthe_age_groups %>% \n  purrr::map_df(~me_fn(m2gh, cohort=.)) %>% \n  mutate(\n    Age = factor(Age),\n    Model = \"With Controls\"\n  ) -> fig3_controls\n```\n:::\n\n\n\n\n# Recreate Figure 3\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfig3_df <- fig3_no_controls %>% bind_rows(fig3_controls)\n\nfig3_df %>% \n  ggplot(aes(Age, Effect))+\n  geom_point()+\n  geom_linerange(aes(ymin = ll, ymax =ul))+\n  geom_hline(yintercept = 0)+\n  theme_minimal()+\n  facet_wrap(~Model)\n```\n\n::: {.cell-output-display}\n![](08-lab-comments_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n:::\n\n\n\n\n# Scratch\n\nPlay around with code:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Timing of that adoption\n# \n# cps %>% \n#   group_by(st,year) %>% \n#   summarize(\n#     sdr = max(sdr),\n#   ) %>% \n#   ungroup() %>% \n#   group_by(st) %>% \n#   mutate(\n#     sdr_state = max(sdr)\n#   ) %>% \n#   mutate(\n#     sdr_year = case_when(\n#       sdr == 1 & lag(sdr) == 0 ~ year,\n#       T ~ NA\n#     )\n#   ) %>% \n#   fill(sdr_year, .direction = \"updown\") %>% \n#   mutate(\n#     time_to_sdr = year - sdr_year,\n#     lag_00yr = case_when(\n#       time_to_sdr==0 ~ 1,\n#       T ~ 0),\n#     lag_02yr = case_when(\n#       time_to_sdr==-2 ~ 1,\n#       T ~ 0),\n#     lag_04yr = case_when(\n#       time_to_sdr==-4 ~ 1,\n#       T ~ 0),\n#     lag_06yr = case_when(\n#       time_to_sdr==-6 ~ 1,\n#       T ~ 0),\n#     lag_08yr = case_when(\n#       time_to_sdr==-8 ~ 1,\n#       T ~ 0),\n#     lag_10yr = case_when(\n#       time_to_sdr==-10 ~ 1,\n#       T ~ 0),\n#     lag_12yr = case_when(\n#       time_to_sdr==-12 ~ 1,\n#       T ~ 0),\n#     lag_14yr = case_when(\n#       time_to_sdr==-14 ~ 1,\n#       T ~ 0),\n#     lag_16yr = case_when(\n#       time_to_sdr==-16 ~ 1,\n#       T ~ 0),\n#     lag_18yr = case_when(\n#       time_to_sdr==-18 ~ 1,\n#       T ~ 0),\n#     lag_20yr = case_when(\n#       time_to_sdr==-20 ~ 1,\n#       T ~ 0),\n#     lead_02yr = case_when(\n#       time_to_sdr == 2 ~ 1,\n#       T ~ 0),\n#     lead_04yr = case_when(\n#       time_to_sdr == 4 ~ 1,\n#       T ~ 0),\n#     lead_06yr = case_when(\n#       time_to_sdr == 6 ~ 1,\n#       T ~ 0),\n#     lead_08yr = case_when(\n#       time_to_sdr == 8 ~ 1,\n#       T ~ 0),\n#     lead_10yr = case_when(\n#       time_to_sdr == 10 ~ 1,\n#       T ~ 0),\n#     lead_12yr = case_when(\n#       time_to_sdr == 12 ~ 1,\n#       T ~ 0),\n#     lead_14yr = case_when(\n#       time_to_sdr == 14 ~ 1,\n#       T ~ 0),\n#     lead_16yr = case_when(\n#       time_to_sdr == 16 ~ 1,\n#       T ~ 0),\n#     lead_18yr = case_when(\n#       time_to_sdr == 18 ~ 1,\n#       T ~ 0),\n#     lead_20yr = case_when(\n#       time_to_sdr == 20 ~ 1,\n#       T ~ 0),\n#   ) -> sdr_event_df\n# \n# \n# cps <- cps %>% left_join(sdr_event_df %>% select(-sdr))\n# \n# \n# m_es <- lm_robust(dv_voted ~ -1 + sdr:lag_04yr + sdr:lag_02yr + sdr:lag_00yr + sdr:lead_02yr + sdr:lead_04yr,\n#                   cps)\n# m_es\n# \n# tmp <- read_csv(\"~/Downloads/data/Most-Recent-Cohorts-Institution.csv\")\n# tmp$INSTNM[1:10]\n```\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../site_libs/htmlwidgets-1.6.4/htmlwidgets.js\"></script>\n<link href=\"../site_libs/datatables-css-0.0.0/datatables-crosstalk.css\" rel=\"stylesheet\" />\n<script src=\"../site_libs/datatables-binding-0.32/datatables.js\"></script>\n<script src=\"../site_libs/jquery-3.6.0/jquery-3.6.0.min.js\"></script>\n<link href=\"../site_libs/dt-core-1.13.6/css/jquery.dataTables.min.css\" rel=\"stylesheet\" />\n<link href=\"../site_libs/dt-core-1.13.6/css/jquery.dataTables.extra.css\" rel=\"stylesheet\" />\n<script src=\"../site_libs/dt-core-1.13.6/js/jquery.dataTables.min.js\"></script>\n<link href=\"../site_libs/crosstalk-1.2.1/css/crosstalk.min.css\" rel=\"stylesheet\" />\n<script src=\"../site_libs/crosstalk-1.2.1/js/crosstalk.min.js\"></script>\n<script src=\"../site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}